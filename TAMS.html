<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html"><link rel="search" title="Search" href="search.html"><link rel="next" title="Usage" href="Controls.html"><link rel="prev" title="Welcome to pyTAMSâ€™s documentation!" href="index.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.09.25 -->
        <title>Theory - pyTAMS 0.0.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="_static/theme.css?v=df66b05f" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">pyTAMS 0.0.5 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <span class="sidebar-brand-text">pyTAMS 0.0.5 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">User corner:</span></p>
<ul class="current">
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="#a-simple-example-2d-double-well">A simple example: 2D double well</a></li>
<li class="toctree-l1"><a class="reference internal" href="Controls.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Controls.html#running-pytams">Running pyTAMS</a></li>
<li class="toctree-l1"><a class="reference internal" href="Controls.html#controls">Controls</a></li>
<li class="toctree-l1"><a class="reference internal" href="Controls.html#loading-the-database">Loading the database</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorials.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer corner:</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="autoapi/pytams/index.html">pytams</a><input aria-label="Toggle navigation of pytams" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/database/index.html">pytams.database</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/fmodel/index.html">pytams.fmodel</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/sqldb/index.html">pytams.sqldb</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/tams/index.html">pytams.tams</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/taskrunner/index.html">pytams.taskrunner</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/trajectory/index.html">pytams.trajectory</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/utils/index.html">pytams.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/worker/index.html">pytams.worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoapi/pytams/xmlutils/index.html">pytams.xmlutils</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/TAMS.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="theory">
<span id="sec-tams"></span><h1>Theory<a class="headerlink" href="#theory" title="Link to this heading">Â¶</a></h1>
<section id="introduction-to-tams">
<h2>Introduction to TAMS<a class="headerlink" href="#introduction-to-tams" title="Link to this heading">Â¶</a></h2>
<p>Trajectory-adaptive Multi-level Sampling (<a class="reference external" href="https://doi.org/10.1088/1742-5468/aab856">TAMS</a>) is concerned with the simulation of rare
events associated with a dynamical process. A rare event is an event with a non-zero, but
very small probability. The probability is so low that naively sampling the stochastic
process outcome with a Monte-Carlo (MC) approach yields no reliable estimate of the probability
within a reasonable simulation time.</p>
<p>Letâ€™s consider a random process <span class="math notranslate nohighlight">\(X \in R^d\)</span> and a measurable set <span class="math notranslate nohighlight">\(Y\)</span>. We want to estimate the probability:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[p = P(X \in Y)\]</div>
</div>
<p>In a naive MC approach, we draw <span class="math notranslate nohighlight">\(K\)</span> i.i.d samples to get the estimate:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\hat{p} = \frac{1}{K} \sum_{i=1}^K \boldsymbol{1}_Y(X_i)\]</div>
</div>
<p>An analysis of the normalized variance of this method shows that the estimator is getting worse when <span class="math notranslate nohighlight">\(p\)</span> goes to zero,
and <span class="math notranslate nohighlight">\(K\)</span> needs to be of the order of <span class="math notranslate nohighlight">\(1/p\)</span>, becoming computationally too expensive for very small <span class="math notranslate nohighlight">\(p\)</span>.</p>
<p>To construct a better estimate, we can use a variance reduction technique. TAMS belong to the family of Importance Splitting
technique and is derived from Adaptive Multilevel Sampling (AMS)
(see for instance the perspective on AMS by <a class="reference external" href="https://doi.org/10.1063/1.5082247">Cerou et al.</a>).
The idea behind AMS is to simulate following the original distribution (in contrast with Importance Sampling which
changes the sampling distribution) and to iteratively discard trajectories that are going away from the measurable set <span class="math notranslate nohighlight">\(Y\)</span>,
while branching trajectories that are going towards <span class="math notranslate nohighlight">\(Y\)</span>. Sorting the trajectories requires defining
a <cite>score function</cite> <span class="math notranslate nohighlight">\(\xi\)</span> (or <cite>reaction coordinate</cite> due the initial development of the method within
the molecular dynamics community). Using <span class="math notranslate nohighlight">\(\xi\)</span>, it is possible to sort the trajectories based on the
its maximum value:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathcal{Q}_i = sup_{t \in [0, T_a]} \; \; \xi(t, X_i(t))\]</div>
</div>
<p>considering that the trajectories of the random process <span class="math notranslate nohighlight">\(X_i\)</span> are sampled on the interval
<span class="math notranslate nohighlight">\([0, T_a]\)</span>. At each iteration <span class="math notranslate nohighlight">\(j\)</span> of TAMS, the <span class="math notranslate nohighlight">\(l_j\)</span> trajectories with the smallest value
of <span class="math notranslate nohighlight">\(\mathcal{Q}\)</span>, <span class="math notranslate nohighlight">\(min (\mathcal{Q}_i) = \mathcal{Q}^*\)</span>, are discarded and new
trajectories are branched from the remaining trajectories and
advanced in time until they reach <span class="math notranslate nohighlight">\(Y\)</span> or until the maximum time <span class="math notranslate nohighlight">\(T_a\)</span> is reached.
The process is illustrated on a small ensemble in the following figure:</p>
<figure class="align-center" id="tams-branching" style="width: 90%">
<img alt="_images/TAMS_Illustration.png" src="_images/TAMS_Illustration.png" />
<figcaption>
<p><span class="caption-text">Branching trajectory <span class="math notranslate nohighlight">\(1\)</span> from <span class="math notranslate nohighlight">\(3\)</span>, starting after <span class="math notranslate nohighlight">\(\xi(t, X_3(t)) &gt; \mathcal{Q}^*\)</span>.</span><a class="headerlink" href="#tams-branching" title="Link to this image">Â¶</a></p>
</figcaption>
</figure>
<p>For each branching or cloning event, a trajectory <span class="math notranslate nohighlight">\(\mathcal{T}_{rep}\)</span> to branch from is selected
at random in the <span class="math notranslate nohighlight">\(N-l_j\)</span> remaining trajectories in the ensemble (where <span class="math notranslate nohighlight">\(N\)</span> is the total number of trajectories in the initial ensemble).
The branching time <span class="math notranslate nohighlight">\(t_b\)</span> along <span class="math notranslate nohighlight">\(\mathcal{T}_{rep}\)</span> is selected to ensure that the branched
trajectory has a score function strictly higher that the discarded one:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[t_b = argmin_{t \in [0, T_a]} \; \; \xi(t, X_{rep}(t) &gt; \mathcal{Q}^*)\]</div>
</div>
<p>This iterative process is repeated until all trajectories reached the measurable set <span class="math notranslate nohighlight">\(Y\)</span> or
until a maximum number of iterations <span class="math notranslate nohighlight">\(J\)</span> is reached. TAMS associate to the trajectories forming
the ensemble at step <span class="math notranslate nohighlight">\(j\)</span> a weight <span class="math notranslate nohighlight">\(w_j\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[w_j = \prod_{i=1}^{j} \left(1 - \frac{l_i}{N} \right) = \left(1 - \frac{l_j}{N} \right)w_{j-1}\]</div>
</div>
<p>Note that <span class="math notranslate nohighlight">\(w_0 = 1\)</span>. The final estimate of <span class="math notranslate nohighlight">\(p\)</span> is given by:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\hat{p} = \frac{N_{\in Y}^J}{N} \prod_{i=0}^J \left(1 - \frac{l_i}{N} \right)\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(N_{\in Y}^J\)</span> is the number of trajectories that reached <span class="math notranslate nohighlight">\(Y\)</span> at step <span class="math notranslate nohighlight">\(J\)</span>.
In practice, we define the observable set <span class="math notranslate nohighlight">\(Y\)</span> as a threshold for the score function <span class="math notranslate nohighlight">\(\xi\)</span>.
TAMS only provides an estimate of <span class="math notranslate nohighlight">\(p\)</span> and the algorithm repeated several times in order to
get a more accurate estimate, as well as a confidence interval. The choice of <span class="math notranslate nohighlight">\(\xi\)</span> is critical
for the performance of the algorithm as well as the quality of the estimate.</p>
<p>An overview of the algorithm is provided hereafter:</p>
<blockquote><ol class="arabic simple">
<li><p>Simulate <span class="math notranslate nohighlight">\(N\)</span> independent trajectories of the dynamical system between [0, <span class="math notranslate nohighlight">\(T_a\)</span>]</p></li>
<li><p>Set <span class="math notranslate nohighlight">\(j = 0\)</span> and <span class="math notranslate nohighlight">\(w[0] = 1\)</span></p></li>
<li><p>while <span class="math notranslate nohighlight">\(j &lt; J\)</span>:</p></li>
<li><p>Â Â Â Â Â Â  compute <span class="math notranslate nohighlight">\(\mathcal{Q}_i\)</span> for all <span class="math notranslate nohighlight">\(i\)</span> in [1, <span class="math notranslate nohighlight">\(N\)</span>] and sort</p></li>
<li><p>Â Â Â Â Â Â  select the <span class="math notranslate nohighlight">\(l_j\)</span> smallest trajectories</p></li>
<li><p>Â Â Â Â Â Â  for <span class="math notranslate nohighlight">\(i\)</span> in [1, <span class="math notranslate nohighlight">\(l_j\)</span>]:</p></li>
<li><p>Â Â Â Â Â Â Â Â Â Â Â Â  select a trajectory <span class="math notranslate nohighlight">\(\mathcal{T}_{rep}\)</span> at random in the <span class="math notranslate nohighlight">\(N-l_j\)</span> remaining trajectories</p></li>
<li><p>Â Â Â Â Â Â Â Â Â Â Â Â  branch from <span class="math notranslate nohighlight">\(\mathcal{T}_{rep}\)</span> at time <span class="math notranslate nohighlight">\(t_b\)</span> and advance <span class="math notranslate nohighlight">\(\mathcal{T}_{i}\)</span> until it reaches <span class="math notranslate nohighlight">\(Y\)</span> or <span class="math notranslate nohighlight">\(T_a\)</span></p></li>
<li><p>Â Â Â Â Â Â  set <span class="math notranslate nohighlight">\(w[j] = (1 - l_j/N) \times w[j-1]\)</span></p></li>
<li><p>Â Â Â Â Â Â  set <span class="math notranslate nohighlight">\(j = j+1\)</span></p></li>
<li><p>Â Â Â Â Â Â  if <span class="math notranslate nohighlight">\(\mathcal{Q}_i &gt; \xi_{max}\)</span> for all <span class="math notranslate nohighlight">\(i\)</span> in [1, <span class="math notranslate nohighlight">\(N\)</span>]:</p></li>
<li><p>Â Â Â Â Â Â Â Â Â Â Â Â  break</p></li>
</ol>
</blockquote></section>
<section id="high-dimension-considerations">
<h2>High-dimension considerations<a class="headerlink" href="#high-dimension-considerations" title="Link to this heading">Â¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>TODO</p>
</div>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">Â¶</a></h1>
<p><cite>pyTAMS</cite> implements the TAMS algorithm while encapsulating all the model-specific
functionalities into an Abstract Base Class (ABC). By decoupling the physics from the
TAMS algorithm, it becomes easier to extend the algorithm to new physics.</p>
<p>In particular, <cite>pyTAMS</cite> aims at tackling computationally expensive stochastic models, such as
high-dimensional dynamical systems appearing in climate modeling or fluid dynamics, which requires
High Performance Computing (HPC) platform to be used. As such, <cite>pyTAMS</cite> can be less efficient
than more simplistic implementations where pure Python physics model can be efficiently vectorized.
The internals of <cite>pyTAMS</cite> relies on a hierarchy of classes to describe data structures, data storage,
workers and eventually the algorithm.</p>
<p>The reader is refered to the API documentation for more details on the classes and functions introduced
hereafter.</p>
<section id="data-structures-storage">
<h2>Data structures &amp; storage<a class="headerlink" href="#data-structures-storage" title="Link to this heading">Â¶</a></h2>
<p><cite>pyTAMS</cite> uses an Array-Of-Structs (AOS) data structure to represent trajectories.
The low-level data container is a <code class="docutils literal notranslate"><span class="pre">snapshot</span></code>, a dataclass gathering the instantaneous state
of the model at a given point, along with a time, a noise increment and a value of the score function.
Note that only the time and score are typed (both as <code class="docutils literal notranslate"><span class="pre">float</span></code>), while the type of the state and noise
are up to the model implementation.</p>
<p>A list of snapshots consistutes a <code class="docutils literal notranslate"><span class="pre">trajectory</span></code>, along with some metadata such as the start and
end times, the step size or the maximum score. The <code class="docutils literal notranslate"><span class="pre">trajectory</span></code> object instanciates the model, and
implements function to advance the model in time or branch a trajectory.</p>
<p>Finally, a list of trajectories is the central container for the TAMSâ€™s <code class="docutils literal notranslate"><span class="pre">database</span></code>. The algorithm
writes, reads and accesses trajectories through the database which also contains TAMS algorithmâ€™s data
such as splitting iterations weights and biases. The <code class="docutils literal notranslate"><span class="pre">database</span></code> can be instanciated independently
from a TAMS run in order to explore the database contents.</p>
</section>
<section id="workers-parallelism">
<h2>Workers &amp; parallelism<a class="headerlink" href="#workers-parallelism" title="Link to this heading">Â¶</a></h2>
<p>The TAMS algorithm exposes parallellism in two places: during the generation of the initial ensemble
of trajectories (line 1 in the highlighted algorithm above), and at each splitting iterations where
more than one trajectory can be branched (the loop on line 6 in the highlighted algorithm).</p>
<p>Distribution of work is handled by a <code class="docutils literal notranslate"><span class="pre">taskrunner</span></code> object, which can have either a <code class="docutils literal notranslate"><span class="pre">dask</span></code> or
an <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> backend. The runner will spawn several workers, picking up tasks submitted to the
runner. When using the <code class="docutils literal notranslate"><span class="pre">dask</span></code> runner with Slurm, the workers are spawned in individual Slurm
jobs.</p>
</section>
<section id="algorithm">
<h2>Algorithm<a class="headerlink" href="#algorithm" title="Link to this heading">Â¶</a></h2>
<p>Finally, the TAMS algorithm is implemented in the <code class="docutils literal notranslate"><span class="pre">TAMS</span></code> class. The instanciation of a <code class="docutils literal notranslate"><span class="pre">TAMS</span></code>
object requires a forward model type and a path to a TOML file to specify the various parameters.</p>
</section>
</section>
<section id="a-simple-example-2d-double-well">
<h1>A simple example: 2D double well<a class="headerlink" href="#a-simple-example-2d-double-well" title="Link to this heading">Â¶</a></h1>
<p>Letâ€™s now look at a simple example of implementing a <code class="docutils literal notranslate"><span class="pre">forward</span> <span class="pre">model</span></code> for a 2D double well model.
In particular, we will cover the basis of the <code class="docutils literal notranslate"><span class="pre">forward</span> <span class="pre">model</span></code> API and the abstract methods
needed during the TAMS algorithm.
Note that the model is available in the <cite>tests/models.py</cite> module.</p>
<p>Letâ€™s first import the necessary modules and define the model class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pytams.fmodel</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForwardModelBaseClass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DoubleWellModel</span><span class="p">(</span><span class="n">ForwardModelBaseClass</span><span class="p">):</span>
<span class="w"> </span><span class="sd">&quot;&quot;&quot;2D double well forward model.</span>

<span class="sd"> V(x,y) = x^4/4 - x^2/2 + y^2</span>

<span class="sd"> Associated SDE:</span>
<span class="sd"> dX_t = -nabla V(X_t)dt + g(X_t)dW_t</span>

<span class="sd"> with:</span>
<span class="sd"> -nabla V(X_t) = [x - x^3, -2y]</span>

<span class="sd"> With the 2 wells at [-1.0, 0.0] and [1.0, 0.0]</span>
<span class="sd"> &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>The first abstract method to implement is the <code class="docutils literal notranslate"><span class="pre">_init_model</span></code> one. It is called by the base
<code class="docutils literal notranslate"><span class="pre">ForwardModelBaseClass</span></code> class and is responsible for initializing model-specific attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_init_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                <span class="n">ioprefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w"> </span><span class="sd">&quot;&quot;&quot;Override the template.&quot;&quot;&quot;</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_condition</span><span class="p">()</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">_noise_amplitude</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;noise_amplitude&quot;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">init_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the initial conditions.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
</pre></div>
</div>
<p>From the code snippet above, we see that the model state consist of the coordinates of
the particle in the 2D space. The <code class="docutils literal notranslate"><span class="pre">_init_model</span></code> method is called by the <code class="docutils literal notranslate"><span class="pre">ForwardModelBaseClass</span></code>
<code class="docutils literal notranslate"><span class="pre">__init__</span></code> and is provided with the <code class="docutils literal notranslate"><span class="pre">params</span></code> dictionary read from the TOML file (see the
Usage section for more details).</p>
<p>We now need to define the <code class="docutils literal notranslate"><span class="pre">_advance</span></code> method responsible for advancing the
system for one stochastic step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
             <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
             <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
             <span class="n">noise</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
             <span class="n">need_end_state</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Advance the particle in the 2D space.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__RHS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise_amplitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dW</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">dt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">__RHS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Double well RHS function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">__dW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">noise</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stochastic forcing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise</span>
</pre></div>
</div>
<dl class="simple">
<dt>A few precisions:</dt><dd><ul class="simple">
<li><p>Note that the time step length <code class="docutils literal notranslate"><span class="pre">dt</span></code> and the noise increment <code class="docutils literal notranslate"><span class="pre">noise</span></code> are provided externally
by the <code class="docutils literal notranslate"><span class="pre">ForwardModelBaseClass</span></code> <code class="docutils literal notranslate"><span class="pre">advance</span></code> method calling the <code class="docutils literal notranslate"><span class="pre">_advance</span></code> method.
This is because the TAMS database keeps
track of the noise history and can rely on that history to move the model forward instead of
generating new noise (when the state stored in the database is subsampled for instance).</p></li>
<li><p>Additionally, the function returns the actual time step length performed by the model.
For complex model, the time step
can be constrained by the physics of the model (e.g. CFL condition) and differ from the stochastic
time step at which the model is advanced within TAMS. The model substeps might not exactly add up
to the provided <code class="docutils literal notranslate"><span class="pre">dt</span></code>, so TAMS will use the returned <code class="docutils literal notranslate"><span class="pre">dt</span></code> to keep track of the model time.</p></li>
<li><p>Finally, the <code class="docutils literal notranslate"><span class="pre">need_end_state</span></code> boolean is used to determine whether the model needs to store the
end state or not. This is not relevant here as we do not store the model state to disk, but for
higher dimentional models, the model state can not be stored in memory and needs to be stored to disk.
Even then, storing to disk at every step might be too expensive such that TAMS can be asked to subsample
the state in the database (see the Usage section for more details) to reduce the storage cost.</p></li>
</ul>
</dd>
</dl>
<p>We now need to define accessors to the model state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_current_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Access the model state.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

<span class="k">def</span><span class="w"> </span><span class="nf">set_current_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the model state.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>
</pre></div>
</div>
<p>For the present model, these two functions are trivial. But for more complex models, the state
might be a path to a file on disk, a dictionary, etc. In that case, more work might be required.</p>
<p>The next abstract method to implement is the <code class="docutils literal notranslate"><span class="pre">make_noise</span></code> one. It is called by the base
<code class="docutils literal notranslate"><span class="pre">ForwardModelBaseClass</span></code> class and is responsible for generating new noise:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w"> </span><span class="sd">&quot;&quot;&quot;Make 2D normal noise.&quot;&quot;&quot;</span>
 <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we need to define the score function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalized weighted distance between two wells.&quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">vA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">vB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">-</span> <span class="n">b</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vA</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vB</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">f1</span>
    <span class="k">return</span> <span class="n">f1</span> <span class="o">-</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">da</span><span class="p">)</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="Controls.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Usage</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Home</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Netherlands eScience Center
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Theory</a><ul>
<li><a class="reference internal" href="#introduction-to-tams">Introduction to TAMS</a></li>
<li><a class="reference internal" href="#high-dimension-considerations">High-dimension considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation">Implementation</a><ul>
<li><a class="reference internal" href="#data-structures-storage">Data structures &amp; storage</a></li>
<li><a class="reference internal" href="#workers-parallelism">Workers &amp; parallelism</a></li>
<li><a class="reference internal" href="#algorithm">Algorithm</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-simple-example-2d-double-well">A simple example: 2D double well</a></li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=282f96c0"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>